{
	"name": "PAM_DF_D_CARRERA",
	"properties": {
		"description": "Dataflow encargado de cargar la DIM_CARRERA",
		"folder": {
			"name": "(PAM) Prospección, Admisión y Matrícula"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "STG_CARRERA_PQT",
						"type": "DatasetReference"
					},
					"name": "StgCarreraParquet",
					"description": "Datos almacenados en Parquet a partir de la Query realizada en Informix On-Premise"
				},
				{
					"dataset": {
						"referenceName": "DIM_CARRERA",
						"type": "DatasetReference"
					},
					"name": "QYDimCarrera",
					"description": "Obtención de SOLO los datos necesarios para determinar cambios en la DIM_CARRERA"
				},
				{
					"dataset": {
						"referenceName": "LK_CARRERAS_SIES",
						"type": "DatasetReference"
					},
					"name": "LKCARRERASIES"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "devtest_eus2_synws_02",
						"type": "LinkedServiceReference"
					},
					"name": "DestinoDimCarrera"
				}
			],
			"transformations": [
				{
					"name": "CodigoHashPorFila",
					"description": "Generación de código Hash a partir de las columnas"
				},
				{
					"name": "DoesntExist",
					"description": "Detección de registros nuevos o con HASH distintos"
				},
				{
					"name": "LookupCodCarrera"
				},
				{
					"name": "SetDates"
				},
				{
					"name": "Upsert",
					"description": "Activar Upsert para DIM_CARRERA"
				},
				{
					"name": "JOIN"
				},
				{
					"name": "Coalesce"
				}
			],
			"scriptLines": [
				"parameters{",
				"     pipeline_run_id as string",
				"}",
				"source(output(",
				"          correlativo_demre as string,",
				"          codigo_carrera_ucsh as string,",
				"          codigo_carrera_demre as integer,",
				"          codigo_mencion_demre_ucsh as string,",
				"          mencion_demre_ucsh as string,",
				"          codigo_mencion_ucsh as string,",
				"          mencion_ucsh as string,",
				"          codigo_carrera_sies as string,",
				"          codigo_carrera_pes_sies as integer,",
				"          codigo_carrera_cned as integer,",
				"          codigo_carrera_cmed as integer,",
				"          carrera_nombre_corto as string,",
				"          carrera_nombre_largo as string,",
				"          carrera_nombre_largo_demre as string,",
				"          codigo_institucion as string,",
				"          codigo_sede as string,",
				"          sigla_institucion as string,",
				"          institucion as string,",
				"          codigo_facultad as string,",
				"          codigo_facultad_dgp as string,",
				"          facultad_nombre_largo as string,",
				"          facultad_nombre_corto as string,",
				"          codigo_escuela as string,",
				"          codigo_escuela_dgp as string,",
				"          escuela_nombre_largo as string,",
				"          escuela_nombre_corto as string,",
				"          codigo_disponible_para_admision as string,",
				"          disponible_para_admision as string,",
				"          codigo_disponible_para_admision_demre as string,",
				"          disponible_para_admision_demre as string,",
				"          codigo_elegible_beca_vocacion_profesor as string,",
				"          elegible_beca_vocacion_profesor as string,",
				"          duracion_semestres as integer,",
				"          codigo_tipo_duracion as string,",
				"          tipo_duracion as string,",
				"          codigo_jornada as string,",
				"          tipo_jornada as string,",
				"          codigo_tipo_educacion as string,",
				"          tipo_educacion as string,",
				"          codigo_es_tecnico_profesional as string,",
				"          codigo_tipo_programa as string,",
				"          tipo_programa as string,",
				"          codigo_grado as string,",
				"          grado as string,",
				"          nivel_formacion_ucsh as string,",
				"          codigo_bonificacion as string,",
				"          bonificacion as string,",
				"          porcentaje_bonificacion as string,",
				"          origen as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'parquet',",
				"     partitionBy('hash', 1)) ~> StgCarreraParquet",
				"source(output(",
				"          CODIGO_CARRERA_UCSH as string,",
				"          CODIGO_CARRERA_DEMRE as integer,",
				"          CODIGO_MENCION_DEMRE_UCSH as string,",
				"          CODIGO_MENCION_UCSH as string,",
				"          CODIGO_HASH as string,",
				"          FECHA_CREACION as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT\\n    CODIGO_CARRERA_UCSH,\\n    CODIGO_CARRERA_DEMRE,\\n    CODIGO_MENCION_DEMRE_UCSH,\\n    CODIGO_MENCION_UCSH,\\n    CODIGO_HASH,\\n    FECHA_CREACION\\nFROM DIM_CARRERA\\nORDER BY CODIGO_CARRERA_UCSH OFFSET 0 ROWS ',",
				"     format: 'query') ~> QYDimCarrera",
				"source(output(",
				"          CODIGO_CARRERA_SIES as string,",
				"          VERSION_SIES as short,",
				"          AREA_DE_CONOCIMIENTO as string,",
				"          CINEF_13_AREA as string,",
				"          CINEF_13_SUBAREA as string,",
				"          MODALIDAD as string,",
				"          ESTA_ACREDITADO as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'select\\nCODIGO_CARRERA_SIES\\n,VERSION AS VERSION_SIES\\n,AREA_DE_CONOCIMIENTO\\n,CINEF_13_AREA\\n,CINEF_13_SUBAREA\\n,MODALIDAD\\n,ESTA_ACREDITADO\\nfrom LK_CARRERAS_SIES\\nwhere CORRELATIVO_CARRERA = 1',",
				"     format: 'query') ~> LKCARRERASIES",
				"Coalesce derive(CODIGO_HASH = md5(\r",
				"    codigo_carrera_ucsh,\r",
				"    codigo_carrera_demre      ,\r",
				"    correlativo_demre      ,\r",
				"    codigo_mencion_demre_ucsh      ,\r",
				"    mencion_demre_ucsh      ,\r",
				"    codigo_mencion_ucsh      ,\r",
				"    mencion_ucsh      ,\r",
				"    StgCarreraParquet@codigo_carrera_sies      ,\r",
				"    codigo_carrera_cned      ,\r",
				"    codigo_carrera_cmed      ,carrera_nombre_corto      ,carrera_nombre_largo      ,carrera_nombre_largo_demre      ,codigo_institucion      ,codigo_sede      ,sigla_institucion      ,institucion      ,codigo_facultad      ,codigo_facultad_dgp      ,facultad_nombre_largo      ,facultad_nombre_corto      ,codigo_escuela      ,codigo_escuela_dgp      ,escuela_nombre_largo      ,escuela_nombre_corto      ,codigo_disponible_para_admision      ,disponible_para_admision      ,codigo_disponible_para_admision_demre      ,disponible_para_admision_demre      ,codigo_elegible_beca_vocacion_profesor      ,elegible_beca_vocacion_profesor      ,duracion_semestres      ,codigo_tipo_duracion      ,codigo_jornada      ,tipo_jornada      ,codigo_tipo_educacion      ,tipo_educacion      ,codigo_es_tecnico_profesional      ,codigo_tipo_programa      ,tipo_programa      ,codigo_grado      ,grado      ,nivel_formacion_ucsh      ,codigo_bonificacion      ,bonificacion      ,porcentaje_bonificacion     ,origen  )) ~> CodigoHashPorFila",
				"CodigoHashPorFila, QYDimCarrera exists(CodigoHashPorFila@CODIGO_HASH == QYDimCarrera@CODIGO_HASH,",
				"     negate:true,",
				"     broadcast: 'left')~> DoesntExist",
				"DoesntExist, QYDimCarrera lookup(StgCarreraParquet@codigo_carrera_ucsh == QYDimCarrera@CODIGO_CARRERA_UCSH",
				"     && StgCarreraParquet@codigo_carrera_demre == QYDimCarrera@CODIGO_CARRERA_DEMRE",
				"     && StgCarreraParquet@codigo_mencion_demre_ucsh == QYDimCarrera@CODIGO_MENCION_DEMRE_UCSH",
				"     && StgCarreraParquet@codigo_mencion_ucsh == QYDimCarrera@CODIGO_MENCION_UCSH,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> LookupCodCarrera",
				"LookupCodCarrera derive(FECHA_CREACION = iif(isNull(FECHA_CREACION), fromUTC(currentUTC(), 'Chile/Continental'), FECHA_CREACION),",
				"          FECHA_ACTUALIZACION = fromUTC(currentUTC(), 'Chile/Continental'),",
				"          tipo_educacion = left(tipo_educacion,40),",
				"          tipo_programa = left(tipo_programa, 30),",
				"          grado = left(grado, 15),",
				"          ETL_ID = $pipeline_run_id) ~> SetDates",
				"SetDates alterRow(upsertIf(true())) ~> Upsert",
				"StgCarreraParquet, LKCARRERASIES join(StgCarreraParquet@codigo_carrera_sies == LKCARRERASIES@CODIGO_CARRERA_SIES,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JOIN",
				"JOIN derive(VERSION_SIES = iif(isNull(VERSION_SIES), 0, toInteger(VERSION_SIES)),",
				"          AREA_DE_CONOCIMIENTO = iif(isNull(AREA_DE_CONOCIMIENTO), 'Sin Información', AREA_DE_CONOCIMIENTO),",
				"          CINEF_13_AREA = iif(isNull(CINEF_13_AREA), 'Sin Información', CINEF_13_AREA),",
				"          CINEF_13_SUBAREA = iif(isNull(CINEF_13_SUBAREA), 'Sin Información', CINEF_13_SUBAREA),",
				"          MODALIDAD = iif(isNull(MODALIDAD), 'Sin Información', MODALIDAD),",
				"          ESTA_ACREDITADO = iif(isNull(ESTA_ACREDITADO), 'Sin Información', ESTA_ACREDITADO)) ~> Coalesce",
				"Upsert sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          CARRERA_SK as integer,",
				"          CODIGO_CARRERA_UCSH as string,",
				"          CODIGO_CARRERA_DEMRE as integer,",
				"          CORRELATIVO_DEMRE as short,",
				"          CODIGO_MENCION_DEMRE_UCSH as string,",
				"          MENCION_DEMRE_UCSH as string,",
				"          CODIGO_MENCION_UCSH as string,",
				"          MENCION_UCSH as string,",
				"          CODIGO_CARRERA_SIES as string,",
				"          CODIGO_CARRERA_PES_SIES as integer,",
				"          CODIGO_CARRERA_CNED as integer,",
				"          CODIGO_CARRERA_CMED as integer,",
				"          CARRERA_NOMBRE_CORTO as string,",
				"          CARRERA_NOMBRE_LARGO as string,",
				"          CARRERA_NOMBRE_LARGO_DEMRE as string,",
				"          VERSION_SIES as short,",
				"          AREA_DE_CONOCIMIENTO as string,",
				"          CINEF_13_AREA as string,",
				"          CINEF_13_SUBAREA as string,",
				"          MODALIDAD as string,",
				"          ESTA_ACREDITADO as string,",
				"          CODIGO_INSTITUCION as string,",
				"          CODIGO_SEDE as string,",
				"          SIGLA_INSTITUCION as string,",
				"          INSTITUCION as string,",
				"          CODIGO_FACULTAD as string,",
				"          CODIGO_FACULTAD_DGP as string,",
				"          FACULTAD_NOMBRE_LARGO as string,",
				"          FACULTAD_NOMBRE_CORTO as string,",
				"          CODIGO_ESCUELA as string,",
				"          CODIGO_ESCUELA_DGP as string,",
				"          ESCUELA_NOMBRE_LARGO as string,",
				"          ESCUELA_NOMBRE_CORTO as string,",
				"          CODIGO_DESHABILITADA_PARA_ADMISION as string,",
				"          DISPONIBLE_PARA_ADMISION as string,",
				"          CODIGO_DESHABILITADA_PARA_ADMISION_DEMRE as string,",
				"          DISPONIBLE_PARA_ADMISION_DEMRE as string,",
				"          CODIGO_ELEGIBLE_BECA_VOCACION_PROFESOR as string,",
				"          ELEGIBLE_BECA_VOCACION_PROFESOR as string,",
				"          DURACION_SEMESTRES as short,",
				"          CODIGO_TIPO_DURACION as string,",
				"          TIPO_DURACION as string,",
				"          CODIGO_JORNADA as string,",
				"          TIPO_JORNADA as string,",
				"          CODIGO_TIPO_EDUCACION as string,",
				"          TIPO_EDUCACION as string,",
				"          CODIGO_ES_TECNICO_PROFESIONAL as string,",
				"          CODIGO_TIPO_PROGRAMA as string,",
				"          TIPO_PROGRAMA as string,",
				"          CODIGO_GRADO as string,",
				"          GRADO as string,",
				"          NIVEL_FORMACION_UCSH as string,",
				"          CODIGO_BONIFICACION as string,",
				"          BONIFICACION as string,",
				"          PORCENTAJE_BONIFICACION as short,",
				"          CODIGO_HASH as string,",
				"          FECHA_CREACION as timestamp,",
				"          FECHA_ACTUALIZACION as timestamp,",
				"          ORIGEN as string,",
				"          ETL_ID as string",
				"     ),",
				"     format: 'table',",
				"     store: 'sqlserver',",
				"     schemaName: 'dbo',",
				"     tableName: 'DIM_CARRERA',",
				"     insertable: false,",
				"     updateable: false,",
				"     deletable: false,",
				"     upsertable: true,",
				"     keys:['codigo_carrera_ucsh','codigo_mencion_demre_ucsh'],",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          CODIGO_CARRERA_UCSH = StgCarreraParquet@codigo_carrera_ucsh,",
				"          CODIGO_CARRERA_DEMRE = StgCarreraParquet@codigo_carrera_demre,",
				"          CORRELATIVO_DEMRE = correlativo_demre,",
				"          CODIGO_MENCION_DEMRE_UCSH = StgCarreraParquet@codigo_mencion_demre_ucsh,",
				"          MENCION_DEMRE_UCSH = mencion_demre_ucsh,",
				"          CODIGO_MENCION_UCSH = StgCarreraParquet@codigo_mencion_ucsh,",
				"          MENCION_UCSH = mencion_ucsh,",
				"          CODIGO_CARRERA_SIES = codigo_carrera_sies,",
				"          CODIGO_CARRERA_PES_SIES = codigo_carrera_pes_sies,",
				"          CODIGO_CARRERA_CNED = codigo_carrera_cned,",
				"          CODIGO_CARRERA_CMED = codigo_carrera_cmed,",
				"          CARRERA_NOMBRE_CORTO = carrera_nombre_corto,",
				"          CARRERA_NOMBRE_LARGO = carrera_nombre_largo,",
				"          CARRERA_NOMBRE_LARGO_DEMRE = carrera_nombre_largo_demre,",
				"          VERSION_SIES,",
				"          AREA_DE_CONOCIMIENTO,",
				"          CINEF_13_AREA,",
				"          CINEF_13_SUBAREA,",
				"          MODALIDAD,",
				"          ESTA_ACREDITADO,",
				"          CODIGO_INSTITUCION = codigo_institucion,",
				"          CODIGO_SEDE = codigo_sede,",
				"          SIGLA_INSTITUCION = sigla_institucion,",
				"          INSTITUCION = institucion,",
				"          CODIGO_FACULTAD = codigo_facultad,",
				"          CODIGO_FACULTAD_DGP = codigo_facultad_dgp,",
				"          FACULTAD_NOMBRE_LARGO = facultad_nombre_largo,",
				"          FACULTAD_NOMBRE_CORTO = facultad_nombre_corto,",
				"          CODIGO_ESCUELA = codigo_escuela,",
				"          CODIGO_ESCUELA_DGP = codigo_escuela_dgp,",
				"          ESCUELA_NOMBRE_LARGO = escuela_nombre_largo,",
				"          ESCUELA_NOMBRE_CORTO = escuela_nombre_corto,",
				"          CODIGO_DESHABILITADA_PARA_ADMISION = codigo_disponible_para_admision,",
				"          DISPONIBLE_PARA_ADMISION = disponible_para_admision,",
				"          CODIGO_DESHABILITADA_PARA_ADMISION_DEMRE = codigo_disponible_para_admision_demre,",
				"          DISPONIBLE_PARA_ADMISION_DEMRE = disponible_para_admision_demre,",
				"          CODIGO_ELEGIBLE_BECA_VOCACION_PROFESOR = codigo_elegible_beca_vocacion_profesor,",
				"          ELEGIBLE_BECA_VOCACION_PROFESOR = elegible_beca_vocacion_profesor,",
				"          DURACION_SEMESTRES = duracion_semestres,",
				"          CODIGO_TIPO_DURACION = codigo_tipo_duracion,",
				"          TIPO_DURACION = tipo_duracion,",
				"          CODIGO_JORNADA = codigo_jornada,",
				"          TIPO_JORNADA = tipo_jornada,",
				"          CODIGO_TIPO_EDUCACION = codigo_tipo_educacion,",
				"          TIPO_EDUCACION = tipo_educacion,",
				"          CODIGO_ES_TECNICO_PROFESIONAL = codigo_es_tecnico_profesional,",
				"          CODIGO_TIPO_PROGRAMA = codigo_tipo_programa,",
				"          TIPO_PROGRAMA = tipo_programa,",
				"          CODIGO_GRADO = codigo_grado,",
				"          GRADO = grado,",
				"          NIVEL_FORMACION_UCSH = nivel_formacion_ucsh,",
				"          CODIGO_BONIFICACION = codigo_bonificacion,",
				"          BONIFICACION = bonificacion,",
				"          PORCENTAJE_BONIFICACION = porcentaje_bonificacion,",
				"          CODIGO_HASH = CodigoHashPorFila@CODIGO_HASH,",
				"          FECHA_CREACION,",
				"          FECHA_ACTUALIZACION,",
				"          ORIGEN = origen,",
				"          ETL_ID",
				"     )) ~> DestinoDimCarrera"
			]
		}
	}
}