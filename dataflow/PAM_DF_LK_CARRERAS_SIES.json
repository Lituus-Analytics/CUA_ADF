{
	"name": "PAM_DF_LK_CARRERAS_SIES",
	"properties": {
		"folder": {
			"name": "(PAM) Prospección, Admisión y Matrícula"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "EXCEL_CARRERAS_SIES",
						"type": "DatasetReference"
					},
					"name": "CSVArchivoSIES"
				},
				{
					"dataset": {
						"referenceName": "LK_CARRERAS_SIES",
						"type": "DatasetReference"
					},
					"name": "LKCARRERASSIESOrigen"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "LK_CARRERAS_SIES",
						"type": "DatasetReference"
					},
					"name": "LKCARRERASSIES"
				}
			],
			"transformations": [
				{
					"name": "CambioNombreColumnas",
					"description": "Cambio de nombres a las columnas que se almacenarán en la tabla LK"
				},
				{
					"name": "CodigoHASH"
				},
				{
					"name": "Fechas"
				},
				{
					"name": "FiltrarSoloCarrerasUCSH"
				},
				{
					"name": "DoesntExist"
				},
				{
					"name": "Lookup"
				},
				{
					"name": "Upsert"
				}
			],
			"scriptLines": [
				"source(output(",
				"          {Año  } as string,",
				"          {Código Único  } as string,",
				"          {Tipo Institución 1  } as string,",
				"          {Tipo Institución 2  } as string,",
				"          {Tipo Institución 3  } as string,",
				"          {Región Sede  } as string,",
				"          {Provincia Sede  } as string,",
				"          {Comuna Sede  } as string,",
				"          {Área del conocimiento  } as string,",
				"          {Cine-F 97 Área} as string,",
				"          {Cine-F 97 Subárea} as string,",
				"          {Área Carrera Genérica} as string,",
				"          {Cine-F 13 Área} as string,",
				"          {Cine-F 13 Subárea} as string,",
				"          {Tipo de institución  } as string,",
				"          {Código IES  } as short,",
				"          {Nombre IES  } as string,",
				"          {Código Sede  } as short,",
				"          {Nombre Sede  } as string,",
				"          {Código Carrera  } as short,",
				"          {Nombre Carrera  } as string,",
				"          {Modalidad  } as string,",
				"          {Jornada  } as string,",
				"          {Versión  } as short,",
				"          {Tipo Carrera  } as string,",
				"          {Plan Especial  } as string,",
				"          {Duración Estudios  } as integer,",
				"          {Duración Titulación  } as integer,",
				"          {Duración Total  } as integer,",
				"          {Régimen } as integer,",
				"          {Duración formal del Régimen } as integer,",
				"          {Nombre Título  } as string,",
				"          {Grado Académico  } as string,",
				"          {Nivel Global  } as string,",
				"          {Nivel Carrera  } as string,",
				"          Demre as integer,",
				"          {Año Inicio  } as short,",
				"          {Acreditación Carrera o Programa } as string,",
				"          {Elegibilidad Beca Pedagogía  } as string,",
				"          {Pedagogía Medicina Odontología, Otro  } as string,",
				"          {Requisito Ingreso  } as string,",
				"          {Semestres reconocidos } as integer,",
				"          {Área Actual  } as integer,",
				"          {Área Dest Agricultura  } as integer,",
				"          {Área Dest Ciencias  } as integer,",
				"          {Área Dest C Soc Comerc Derecho  } as integer,",
				"          {Área Dest Educación  } as integer,",
				"          {Área Dest Humanidades y Artes   } as integer,",
				"          {Área Dest Ing Ind Const  } as integer,",
				"          {Área Dest Salud y Serv Soc  } as integer,",
				"          {Área Dest Servicios  } as integer,",
				"          {Ponderación Notas  } as integer,",
				"          {Ponderación Ranking Notas  } as integer,",
				"          {Ponderación Lenguaje  } as integer,",
				"          {Ponderación Matemáticas} as integer,",
				"          {Ponderación Matemáticas 2} as integer,",
				"          {Ponderación Historia  } as integer,",
				"          {Ponderación Ciencias  } as integer,",
				"          {Ponderación Otros  } as integer,",
				"          {Vacantes Semestre Uno  } as integer,",
				"          {Vacantes Semestre Dos  } as integer,",
				"          {Formato Valor} as string,",
				"          {Matrícula Anual  } as integer,",
				"          {Costo Titulación  } as integer,",
				"          {Costo Certificado Diploma  } as integer,",
				"          {Arancel Anual  } as integer,",
				"          {Vigencia  } as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> CSVArchivoSIES",
				"source(output(",
				"          ANIO as string,",
				"          CODIGO_IES as short,",
				"          CODIGO_CARRERA_SIES as string,",
				"          CODIGO_HASH as string,",
				"          FECHA_CREACION as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT \\nANIO,CODIGO_IES,CODIGO_CARRERA_SIES,CODIGO_HASH,FECHA_CREACION\\nFROM LK_CARRERAS_SIES',",
				"     format: 'query') ~> LKCARRERASSIESOrigen",
				"FiltrarSoloCarrerasUCSH derive(ANIO = split({Año  }, '_')[2],",
				"          CODIGO_IES = {Código IES  },",
				"          CODIGO_CARRERA_SIES = {Código Único  },",
				"          CODIGO_CARRERA_UCSH = iif(\r",
				"    equals(length(toString({Código Carrera  })),3), \r",
				"    toString({Código Carrera  }), \r",
				"    iif(\r",
				"        equals(length(toString({Código Carrera  })),2), \r",
				"        concat('0',toString({Código Carrera  })), \r",
				"        concat('00',toString({Código Carrera  }))\r",
				"        )\r",
				"    ),",
				"          CODIGO_CARRERA_DEMRE = Demre,",
				"          CARRERA_NOMBRE_LARGO = {Nombre Carrera  },",
				"          VERSION = {Versión  },",
				"          VIGENCIA = {Vigencia  },",
				"          AREA_DE_CONOCIMIENTO = {Área del conocimiento  },",
				"          AREA_CARRERA_GENERICA = {Área Carrera Genérica},",
				"          CINEF_97_AREA = {Cine-F 97 Área},",
				"          CINEF_97_SUBAREA = {Cine-F 97 Subárea},",
				"          CINEF_13_AREA = {Cine-F 13 Área},",
				"          CINEF_13_SUBAREA = {Cine-F 13 Subárea},",
				"          MODALIDAD = iif(isNull({Modalidad  }),\"Sin Información\",{Modalidad  }),",
				"          JORNADA = {Jornada  },",
				"          TIPO_CARRERA = {Tipo Carrera  },",
				"          PLAN_ESPECIAL = {Plan Especial  },",
				"          SEMESTRES_PLAN_DE_ESTUDIO = {Duración Estudios  },",
				"          SEMESTRES_TITULACION = {Duración Titulación  },",
				"          SEMESTRES_TOTAL = {Duración Total  },",
				"          REGIMEN = iif(isNull({Régimen }),-1,toInteger({Régimen })),",
				"          DURACION_CARRERA_SEGUN_REGIMEN = iif(isNull({Duración formal del Régimen }),-1,toInteger({Duración formal del Régimen })),",
				"          NOMBRE_TITULO = {Nombre Título  },",
				"          GRADO_ACADEMICO = {Grado Académico  },",
				"          GRADO_CARRERA = {Nivel Global  },",
				"          NIVEL_FORMACION = {Nivel Carrera  },",
				"          ANIO_INICIO_CARRERA = {Año Inicio  },",
				"          ESTA_ACREDITADO = iif(isNull({Acreditación Carrera o Programa }),\"Sin Información\",{Acreditación Carrera o Programa }),",
				"          ELEGIBLE_BECA_PEDAGOGIA = iif(isNull({Elegibilidad Beca Pedagogía  }),'Sin Información','?'),",
				"          REQUISITO_INGRESO = iif(isNull({Requisito Ingreso  }),\"Sin Información\",{Requisito Ingreso  }),",
				"          SEMESTRES_RECONOCIDOS_LEY_21091 = iif(isNull({Semestres reconocidos }),-1,toInteger({Semestres reconocidos })),",
				"          PONDERACION_NOTAS = {Ponderación Notas  },",
				"          PONDERACION_RANKING_NOTAS = iif(isNull({Ponderación Ranking Notas  }),0,toInteger({Ponderación Ranking Notas  })),",
				"          PONDERACION_LENGUAJE = {Ponderación Lenguaje  },",
				"          PONDERACION_MATEMATICAS = {Ponderación Matemáticas},",
				"          PONDERACION_MATEMATICA_2 = iif(isNull({Ponderación Matemáticas 2}),0,{Ponderación Matemáticas 2}),",
				"          PONDERACION_HISTORIA = {Ponderación Historia  },",
				"          PONDERACION_CIENCIAS = {Ponderación Ciencias  },",
				"          PONDERACION_OTROS = iif(isNull({Ponderación Otros  }),0,{Ponderación Otros  }),",
				"          VACANTES_PRIMER_SEMESTRE = {Vacantes Semestre Uno  },",
				"          VACANTES_SEGUNDO_SEMESTRE = {Vacantes Semestre Dos  },",
				"          FORMATO_MONETARIO = iif(isNull({Formato Valor}),\"Sin Información\",{Formato Valor}),",
				"          ARANCEL_ANUAL = {Arancel Anual  },",
				"          MATRICULA_ANUAL = {Matrícula Anual  },",
				"          COSTO_TITULACION = iif(isNull({Costo Titulación  }),-1,{Costo Titulación  }),",
				"          COSTO_CERTIFICADO_DIPLOMA = iif(isNull({Costo Certificado Diploma  }),-1,{Costo Certificado Diploma  })) ~> CambioNombreColumnas",
				"CambioNombreColumnas derive(CODIGO_HASH = md5(\r",
				"    ANIO,CODIGO_IES,CODIGO_CARRERA_SIES,CODIGO_CARRERA_UCSH,CODIGO_CARRERA_DEMRE,CARRERA_NOMBRE_LARGO,VERSION,VIGENCIA,AREA_DE_CONOCIMIENTO,AREA_CARRERA_GENERICA,CINEF_97_AREA,CINEF_97_SUBAREA,\r",
				"    CINEF_13_AREA,CINEF_13_SUBAREA,MODALIDAD,JORNADA,TIPO_CARRERA,PLAN_ESPECIAL,SEMESTRES_PLAN_DE_ESTUDIO,SEMESTRES_TITULACION,SEMESTRES_TOTAL,REGIMEN,DURACION_CARRERA_SEGUN_REGIMEN,NOMBRE_TITULO,\r",
				"    GRADO_ACADEMICO,GRADO_CARRERA,NIVEL_FORMACION,ANIO_INICIO_CARRERA,ESTA_ACREDITADO,ELEGIBLE_BECA_PEDAGOGIA,REQUISITO_INGRESO,SEMESTRES_RECONOCIDOS_LEY_21091,PONDERACION_NOTAS,PONDERACION_RANKING_NOTAS,\r",
				"    PONDERACION_LENGUAJE,PONDERACION_MATEMATICAS,PONDERACION_MATEMATICA_2,PONDERACION_HISTORIA,PONDERACION_CIENCIAS,PONDERACION_OTROS,VACANTES_PRIMER_SEMESTRE,VACANTES_SEGUNDO_SEMESTRE,FORMATO_MONETARIO,\r",
				"    ARANCEL_ANUAL,MATRICULA_ANUAL,COSTO_TITULACION,COSTO_CERTIFICADO_DIPLOMA \r",
				")) ~> CodigoHASH",
				"Lookup derive(FECHA_CREACION = iif(isNull(FECHA_CREACION), fromUTC(currentUTC(), 'Chile/Continental'), FECHA_CREACION),",
				"          FECHA_ACTUALIZACION = fromUTC(currentUTC(), 'Chile/Continental'),",
				"          ORIGEN = 'EXCEL OFERTA ACADEMICA SIES') ~> Fechas",
				"CSVArchivoSIES filter({Código IES  } == 42) ~> FiltrarSoloCarrerasUCSH",
				"CodigoHASH, LKCARRERASSIESOrigen exists(CodigoHASH@CODIGO_HASH == LKCARRERASSIESOrigen@CODIGO_HASH,",
				"     negate:true,",
				"     broadcast: 'auto')~> DoesntExist",
				"DoesntExist, LKCARRERASSIESOrigen lookup(CambioNombreColumnas@CODIGO_CARRERA_SIES == LKCARRERASSIESOrigen@CODIGO_CARRERA_SIES",
				"     && CambioNombreColumnas@ANIO == LKCARRERASSIESOrigen@ANIO",
				"     && CambioNombreColumnas@CODIGO_IES == LKCARRERASSIESOrigen@CODIGO_IES,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> Lookup",
				"Fechas alterRow(upsertIf(true())) ~> Upsert",
				"Upsert sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     deletable:false,",
				"     insertable:false,",
				"     updateable:false,",
				"     upsertable:true,",
				"     keys:['CODIGO_CARRERA_SIES','CODIGO_IES','ANIO'],",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          ANIO = CambioNombreColumnas@ANIO,",
				"          CODIGO_IES = CambioNombreColumnas@CODIGO_IES,",
				"          CODIGO_CARRERA_SIES = CambioNombreColumnas@CODIGO_CARRERA_SIES,",
				"          CODIGO_CARRERA_UCSH,",
				"          CODIGO_CARRERA_DEMRE,",
				"          CARRERA_NOMBRE_LARGO,",
				"          VERSION,",
				"          VIGENCIA,",
				"          AREA_DE_CONOCIMIENTO,",
				"          AREA_CARRERA_GENERICA,",
				"          CINEF_97_AREA,",
				"          CINEF_97_SUBAREA,",
				"          CINEF_13_AREA,",
				"          CINEF_13_SUBAREA,",
				"          MODALIDAD,",
				"          JORNADA,",
				"          TIPO_CARRERA,",
				"          PLAN_ESPECIAL,",
				"          SEMESTRES_PLAN_DE_ESTUDIO,",
				"          SEMESTRES_TITULACION,",
				"          SEMESTRES_TOTAL,",
				"          REGIMEN,",
				"          DURACION_CARRERA_SEGUN_REGIMEN,",
				"          NOMBRE_TITULO,",
				"          GRADO_ACADEMICO,",
				"          GRADO_CARRERA,",
				"          NIVEL_FORMACION,",
				"          ANIO_INICIO_CARRERA,",
				"          ESTA_ACREDITADO,",
				"          ELEGIBLE_BECA_PEDAGOGIA,",
				"          REQUISITO_INGRESO,",
				"          SEMESTRES_RECONOCIDOS_LEY_21091,",
				"          PONDERACION_NOTAS,",
				"          PONDERACION_RANKING_NOTAS,",
				"          PONDERACION_LENGUAJE,",
				"          PONDERACION_MATEMATICAS,",
				"          PONDERACION_MATEMATICA_2,",
				"          PONDERACION_HISTORIA,",
				"          PONDERACION_CIENCIAS,",
				"          PONDERACION_OTROS,",
				"          VACANTES_PRIMER_SEMESTRE,",
				"          VACANTES_SEGUNDO_SEMESTRE,",
				"          FORMATO_MONETARIO,",
				"          ARANCEL_ANUAL,",
				"          MATRICULA_ANUAL,",
				"          COSTO_TITULACION,",
				"          COSTO_CERTIFICADO_DIPLOMA,",
				"          CODIGO_HASH = CodigoHASH@CODIGO_HASH,",
				"          FECHA_CREACION,",
				"          FECHA_ACTUALIZACION,",
				"          ORIGEN",
				"     )) ~> LKCARRERASSIES"
			]
		}
	}
}